
<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta charset="utf-8" />
    <title>align.circuit.core &#8212; ALIGN 0.9 documentation</title>
    <link rel="stylesheet" href="../../../_static/classic.css" type="text/css" />
    <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript" id="documentation_options" data-url_root="../../../" src="../../../_static/documentation_options.js"></script>
    <script type="text/javascript" src="../../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../../_static/doctools.js"></script>
    <script type="text/javascript" src="../../../_static/language_data.js"></script>
    
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 
  </head><body>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../../index.html">ALIGN 0.9 documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../../index.html" accesskey="U">Module code</a> &#187;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for align.circuit.core</h1><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">networkx</span>
<span class="kn">from</span> <span class="nn">collections.abc</span> <span class="kn">import</span> <span class="n">Iterable</span>

<div class="viewcode-block" id="NTerminalDevice"><a class="viewcode-back" href="../../../align.circuit.html#align.circuit.core.NTerminalDevice">[docs]</a><span class="k">class</span> <span class="nc">NTerminalDevice</span><span class="p">():</span>

    <span class="n">_prefix</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
    <span class="n">_pins</span> <span class="o">=</span> <span class="p">()</span>
    <span class="n">_parameters</span> <span class="o">=</span> <span class="p">{}</span> <span class="c1"># name : defaultval</span>

    <span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
    <span class="n">pins</span> <span class="o">=</span> <span class="p">{}</span> <span class="c1"># name: net</span>
    <span class="n">parameters</span> <span class="o">=</span> <span class="p">{}</span> <span class="c1"># name : val</span>

<div class="viewcode-block" id="NTerminalDevice.add_parameters"><a class="viewcode-back" href="../../../align.circuit.html#align.circuit.core.NTerminalDevice.add_parameters">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">add_parameters</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">parameters</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_parameters</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">parameters</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="o">*</span><span class="n">pins</span><span class="p">,</span> <span class="o">**</span><span class="n">parameters</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_prefix</span><span class="p">),</span> <span class="sa">f</span><span class="s1">&#39;Prefix is </span><span class="si">{self._prefix}</span><span class="s1">&#39;</span> <span class="o">+</span> \
            <span class="s1">&#39;. Did you try overwriting an inbuilt element with subckt?&#39;</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_prefix</span> <span class="o">==</span> <span class="s1">&#39;X&#39;</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span>
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">pins</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_pins</span><span class="p">),</span> <span class="sa">f</span><span class="s2">&quot;One or more positional arguments has not been specified. Need name and pins </span><span class="si">{self._pins}</span><span class="s2">&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pins</span> <span class="o">=</span> <span class="p">{</span><span class="n">pin</span><span class="p">:</span> <span class="n">net</span> <span class="k">for</span> <span class="n">pin</span><span class="p">,</span> <span class="n">net</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_pins</span><span class="p">,</span> <span class="n">pins</span><span class="p">)}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parameters</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="k">assert</span> <span class="nb">all</span><span class="p">(</span><span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parameters</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">parameters</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">parameters</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{self.name}</span><span class="s1"> &#39;</span> <span class="o">+</span> \
            <span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pins</span><span class="o">.</span><span class="n">values</span><span class="p">())</span> <span class="o">+</span> \
            <span class="sa">f</span><span class="s1">&#39; </span><span class="si">{self.__class__.__name__}</span><span class="s1"> &#39;</span> <span class="o">+</span> \
            <span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{x}</span><span class="s1">=&#39;</span><span class="o">+</span> <span class="p">(</span><span class="sa">f</span><span class="s1">&#39;{{</span><span class="si">{y}</span><span class="s1">}}&#39;</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="k">else</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{y}</span><span class="s1">&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">items</span><span class="p">())</span></div>

<div class="viewcode-block" id="Circuit"><a class="viewcode-back" href="../../../align.circuit.html#align.circuit.core.Circuit">[docs]</a><span class="k">class</span> <span class="nc">Circuit</span><span class="p">(</span><span class="n">networkx</span><span class="o">.</span><span class="n">Graph</span><span class="p">):</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_is_element</span><span class="p">(</span><span class="n">v</span><span class="p">):</span>
        <span class="k">return</span> <span class="s1">&#39;instance&#39;</span> <span class="ow">in</span> <span class="n">v</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">elements</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">v</span><span class="p">[</span><span class="s1">&#39;instance&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">nodes</span><span class="o">.</span><span class="n">values</span><span class="p">()</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_element</span><span class="p">(</span><span class="n">v</span><span class="p">)]</span>

<div class="viewcode-block" id="Circuit.element"><a class="viewcode-back" href="../../../align.circuit.html#align.circuit.core.Circuit.element">[docs]</a>    <span class="k">def</span> <span class="nf">element</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="k">assert</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">nodes</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_element</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="n">name</span><span class="p">]),</span> <span class="n">name</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="n">name</span><span class="p">][</span><span class="s1">&#39;instance&#39;</span><span class="p">]</span></div>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">nets</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">nodes</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_element</span><span class="p">(</span><span class="n">v</span><span class="p">)]</span>

<div class="viewcode-block" id="Circuit.add_element"><a class="viewcode-back" href="../../../align.circuit.html#align.circuit.core.Circuit.add_element">[docs]</a>    <span class="k">def</span> <span class="nf">add_element</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">element</span><span class="p">):</span>
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">element</span><span class="p">,</span> <span class="n">NTerminalDevice</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">pin</span><span class="p">,</span> <span class="n">net</span> <span class="ow">in</span> <span class="n">element</span><span class="o">.</span><span class="n">pins</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">has_edge</span><span class="p">(</span><span class="n">element</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">net</span><span class="p">):</span>
                <span class="bp">self</span><span class="p">[</span><span class="n">element</span><span class="o">.</span><span class="n">name</span><span class="p">][</span><span class="n">net</span><span class="p">][</span><span class="s1">&#39;pin&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">pin</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">add_edge</span><span class="p">(</span><span class="n">element</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">net</span><span class="p">,</span> <span class="n">pin</span><span class="o">=</span><span class="p">{</span><span class="n">pin</span><span class="p">})</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="n">element</span><span class="o">.</span><span class="n">name</span><span class="p">][</span><span class="s1">&#39;instance&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">element</span>
        <span class="k">return</span> <span class="n">element</span></div>

<div class="viewcode-block" id="Circuit.remove_element"><a class="viewcode-back" href="../../../align.circuit.html#align.circuit.core.Circuit.remove_element">[docs]</a>    <span class="k">def</span> <span class="nf">remove_element</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">element</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">remove_nodes_from</span><span class="p">([</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">neighbors</span><span class="p">(</span><span class="n">element</span><span class="o">.</span><span class="n">name</span><span class="p">)</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">degree</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">remove_node</span><span class="p">(</span><span class="n">element</span><span class="o">.</span><span class="n">name</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{x}</span><span class="s1">&#39;</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">elements</span><span class="p">)</span>

    <span class="c1"># Algorithms to find &amp; replace subgraph / subckt matches</span>

<div class="viewcode-block" id="Circuit.default_node_match"><a class="viewcode-back" href="../../../align.circuit.html#align.circuit.core.Circuit.default_node_match">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">default_node_match</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">issubclass</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;instance&#39;</span><span class="p">)),</span> <span class="nb">type</span><span class="p">(</span><span class="n">y</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;instance&#39;</span><span class="p">)))</span></div>

<div class="viewcode-block" id="Circuit.default_edge_match"><a class="viewcode-back" href="../../../align.circuit.html#align.circuit.core.Circuit.default_edge_match">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">default_edge_match</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">x</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;pin&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="n">y</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;pin&#39;</span><span class="p">)</span></div>

<div class="viewcode-block" id="Circuit.find_subgraph_matches"><a class="viewcode-back" href="../../../align.circuit.html#align.circuit.core.Circuit.find_subgraph_matches">[docs]</a>    <span class="k">def</span> <span class="nf">find_subgraph_matches</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">graph</span><span class="p">,</span> <span class="n">node_match</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">edge_match</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">node_match</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">node_match</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">default_node_match</span>
        <span class="k">if</span> <span class="n">edge_match</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">edge_match</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">default_edge_match</span>
        <span class="n">matcher</span> <span class="o">=</span> <span class="n">networkx</span><span class="o">.</span><span class="n">algorithms</span><span class="o">.</span><span class="n">isomorphism</span><span class="o">.</span><span class="n">GraphMatcher</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span> <span class="n">graph</span><span class="p">,</span> <span class="n">node_match</span><span class="o">=</span><span class="n">node_match</span><span class="p">,</span> <span class="n">edge_match</span><span class="o">=</span><span class="n">edge_match</span><span class="p">)</span>
        <span class="n">ret</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">match</span> <span class="ow">in</span> <span class="n">matcher</span><span class="o">.</span><span class="n">subgraph_isomorphisms_iter</span><span class="p">():</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">any</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_is_element</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="n">node</span><span class="p">])</span> <span class="ow">and</span> <span class="nb">any</span><span class="p">(</span><span class="n">node</span> <span class="ow">in</span> <span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">ret</span><span class="p">)</span> <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">match</span><span class="p">):</span>
                <span class="n">ret</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">match</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">ret</span></div>

<div class="viewcode-block" id="Circuit.replace_matching_subckts"><a class="viewcode-back" href="../../../align.circuit.html#align.circuit.core.Circuit.replace_matching_subckts">[docs]</a>    <span class="k">def</span> <span class="nf">replace_matching_subckts</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">subckts</span><span class="p">,</span> <span class="n">node_match</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">edge_match</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">subckts</span><span class="p">,</span> <span class="n">Iterable</span><span class="p">):</span>
            <span class="n">subckts</span> <span class="o">=</span> <span class="p">[</span><span class="n">subckts</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">subckt</span> <span class="ow">in</span> <span class="n">subckts</span><span class="p">:</span>
            <span class="n">matches</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">find_subgraph_matches</span><span class="p">(</span><span class="n">subckt</span><span class="o">.</span><span class="n">circuit</span><span class="p">,</span> <span class="n">node_match</span><span class="p">,</span> <span class="n">edge_match</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_replace_matches_with_subckt</span><span class="p">(</span><span class="n">matches</span><span class="p">,</span> <span class="n">subckt</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">_replace_matches_with_subckt</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">matches</span><span class="p">,</span> <span class="n">subckt</span><span class="p">):</span>
        <span class="k">assert</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">subckt</span><span class="p">,</span> <span class="s1">&#39;circuit&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">subckt</span><span class="o">.</span><span class="n">circuit</span><span class="p">,</span> <span class="n">Circuit</span><span class="p">)</span>
        <span class="n">counter</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">match</span> <span class="ow">in</span> <span class="n">matches</span><span class="p">:</span>
            <span class="c1"># Cannot replace as some prior transformation has made the current one invalid</span>
            <span class="k">assert</span> <span class="nb">all</span><span class="p">(</span><span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">nodes</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">match</span><span class="p">)</span>
            <span class="c1"># Cannot replace as internal node is used elsewhere in circuit</span>
            <span class="n">internal_nodes</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="ow">in</span> <span class="n">match</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">y</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">subckt</span><span class="o">.</span><span class="n">_pins</span><span class="p">]</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">all</span><span class="p">(</span><span class="n">x</span> <span class="ow">in</span> <span class="n">match</span> <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">internal_nodes</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">neighbors</span><span class="p">(</span><span class="n">node</span><span class="p">)):</span>
                <span class="k">continue</span>
            <span class="c1"># Remove nodes not on subckt boundary</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">remove_nodes_from</span><span class="p">(</span><span class="n">internal_nodes</span><span class="p">)</span>
            <span class="c1"># Create new instance of subckt</span>
            <span class="n">name</span><span class="p">,</span> <span class="n">counter</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;X_</span><span class="si">{subckt.__name__}</span><span class="s1">_</span><span class="si">{counter}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">counter</span> <span class="o">+</span> <span class="mi">1</span>
            <span class="k">assert</span> <span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">elements</span>
            <span class="n">pinmap</span> <span class="o">=</span> <span class="p">{</span><span class="n">pin</span><span class="p">:</span> <span class="n">net</span> <span class="k">for</span> <span class="n">net</span><span class="p">,</span> <span class="n">pin</span> <span class="ow">in</span> <span class="n">match</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">pin</span> <span class="ow">in</span> <span class="n">subckt</span><span class="o">.</span><span class="n">_pins</span><span class="p">}</span>
            <span class="k">assert</span> <span class="nb">all</span><span class="p">(</span><span class="n">x</span> <span class="ow">in</span> <span class="n">pinmap</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">subckt</span><span class="o">.</span><span class="n">_pins</span><span class="p">),</span> <span class="p">(</span><span class="n">match</span><span class="p">,</span> <span class="n">subckt</span><span class="p">)</span>
            <span class="n">inst</span> <span class="o">=</span> <span class="n">subckt</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="o">*</span><span class="p">[</span><span class="n">pinmap</span><span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">subckt</span><span class="o">.</span><span class="n">_pins</span><span class="p">])</span>
            <span class="c1"># attach instance to current graph</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">add_element</span><span class="p">(</span><span class="n">inst</span><span class="p">)</span>

    <span class="c1"># Algorithms to find &amp; replace repeated subgraphs</span>

<div class="viewcode-block" id="Circuit.find_repeated_subckts"><a class="viewcode-back" href="../../../align.circuit.html#align.circuit.core.Circuit.find_repeated_subckts">[docs]</a>    <span class="k">def</span> <span class="nf">find_repeated_subckts</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">replace</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="n">index</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">subckts</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">worklist</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">elements</span><span class="p">)</span>
        <span class="k">while</span> <span class="nb">len</span><span class="p">(</span><span class="n">worklist</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="c1"># Create new graph with a single element</span>
            <span class="n">ckt</span> <span class="o">=</span> <span class="n">Circuit</span><span class="p">()</span>
            <span class="n">ckt</span><span class="o">.</span><span class="n">add_element</span><span class="p">(</span><span class="n">worklist</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span>
            <span class="c1"># Grow graph iteratively &amp; look for subgraph matches</span>
            <span class="n">matchlist</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_match_candidates</span><span class="p">(</span><span class="n">worklist</span><span class="p">,</span> <span class="n">ckt</span><span class="p">)</span>
            <span class="k">while</span> <span class="nb">len</span><span class="p">(</span><span class="n">matchlist</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">element</span> <span class="o">=</span> <span class="n">matchlist</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
                <span class="n">ckt</span><span class="o">.</span><span class="n">add_element</span><span class="p">(</span><span class="n">element</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">find_subgraph_matches</span><span class="p">(</span><span class="n">ckt</span><span class="p">))</span> <span class="o">&lt;=</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">ckt</span><span class="o">.</span><span class="n">remove_element</span><span class="p">(</span><span class="n">element</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">matchlist</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_match_candidates</span><span class="p">(</span><span class="n">worklist</span><span class="p">,</span> <span class="n">ckt</span><span class="p">)</span>
            <span class="c1"># Create subcircuit &amp; update worklist if needed</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">ckt</span><span class="o">.</span><span class="n">elements</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">pinmap</span> <span class="o">=</span> <span class="p">{</span><span class="n">y</span><span class="p">:</span> <span class="sa">f</span><span class="s1">&#39;pin</span><span class="si">{x}</span><span class="s1">&#39;</span> <span class="k">for</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span>
                    <span class="p">(</span><span class="n">net</span> <span class="k">for</span> <span class="n">net</span> <span class="ow">in</span> <span class="n">ckt</span><span class="o">.</span><span class="n">nets</span> \
                        <span class="k">if</span> <span class="ow">not</span> <span class="nb">all</span><span class="p">(</span><span class="n">neighbor</span> <span class="ow">in</span> <span class="n">ckt</span><span class="o">.</span><span class="n">nodes</span> <span class="k">for</span> <span class="n">neighbor</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">neighbors</span><span class="p">(</span><span class="n">net</span><span class="p">))))}</span>
                <span class="n">subckt</span><span class="p">,</span> <span class="n">index</span> <span class="o">=</span> <span class="n">SubCircuit</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;XREP</span><span class="si">{index}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="o">*</span><span class="nb">list</span><span class="p">(</span><span class="n">pinmap</span><span class="o">.</span><span class="n">values</span><span class="p">())),</span> <span class="n">index</span> <span class="o">+</span> <span class="mi">1</span>
                <span class="k">for</span> <span class="n">element</span> <span class="ow">in</span> <span class="n">ckt</span><span class="o">.</span><span class="n">elements</span><span class="p">:</span>
                    <span class="n">subckt</span><span class="o">.</span><span class="n">add_element</span><span class="p">(</span><span class="n">element</span><span class="o">.</span><span class="vm">__class__</span><span class="p">(</span><span class="n">element</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
                        <span class="o">*</span><span class="p">[</span><span class="n">pinmap</span><span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="k">if</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">pinmap</span> <span class="k">else</span> <span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">element</span><span class="o">.</span><span class="n">pins</span><span class="o">.</span><span class="n">values</span><span class="p">()]))</span>
                <span class="n">subckts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">subckt</span><span class="p">)</span>
                <span class="n">matches</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">find_subgraph_matches</span><span class="p">(</span><span class="n">subckt</span><span class="o">.</span><span class="n">circuit</span><span class="p">)</span>
                <span class="n">worklist</span> <span class="o">=</span> <span class="p">[</span><span class="n">element</span> <span class="k">for</span> <span class="n">element</span> <span class="ow">in</span> <span class="n">worklist</span> <span class="k">if</span> <span class="ow">not</span> <span class="nb">any</span><span class="p">(</span><span class="n">element</span><span class="o">.</span><span class="n">name</span> <span class="ow">in</span> <span class="n">match</span> <span class="k">for</span> <span class="n">match</span> <span class="ow">in</span> <span class="n">matches</span><span class="p">)]</span>
                <span class="k">if</span> <span class="n">replace</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_replace_matches_with_subckt</span><span class="p">(</span><span class="n">matches</span><span class="p">,</span> <span class="n">subckt</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">subckts</span></div>

<div class="viewcode-block" id="Circuit.replace_repeated_subckts"><a class="viewcode-back" href="../../../align.circuit.html#align.circuit.core.Circuit.replace_repeated_subckts">[docs]</a>    <span class="k">def</span> <span class="nf">replace_repeated_subckts</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">find_repeated_subckts</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">_get_match_candidates</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">worklist</span><span class="p">,</span> <span class="n">ckt</span><span class="p">):</span>
        <span class="c1"># Pick circuit elements that have some net-name based overlap with ckt subgraph</span>
        <span class="n">matchlist</span> <span class="o">=</span> <span class="p">[</span><span class="n">element</span> <span class="k">for</span> <span class="n">element</span> <span class="ow">in</span> <span class="n">worklist</span> <span class="k">if</span> <span class="n">element</span><span class="o">.</span><span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">ckt</span> <span class="ow">and</span> <span class="nb">any</span><span class="p">(</span><span class="n">x</span> <span class="ow">in</span> <span class="n">ckt</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">neighbors</span><span class="p">(</span><span class="n">element</span><span class="o">.</span><span class="n">name</span><span class="p">))]</span>
        <span class="c1"># Sort circuit elements to minimize the number of (net) nodes added to ckt subgraph</span>
        <span class="n">matchlist</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">element</span><span class="p">:</span> <span class="nb">sum</span><span class="p">([</span><span class="n">x</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">ckt</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">neighbors</span><span class="p">(</span><span class="n">element</span><span class="o">.</span><span class="n">name</span><span class="p">)]))</span>
        <span class="k">return</span> <span class="n">matchlist</span>

    <span class="c1"># Algorithms to flatten netlist</span>

<div class="viewcode-block" id="Circuit.flatten"><a class="viewcode-back" href="../../../align.circuit.html#align.circuit.core.Circuit.flatten">[docs]</a>    <span class="k">def</span> <span class="nf">flatten</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">depth</span><span class="o">=</span><span class="mi">999</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39; depth = 999 helps protect against recursive subckt definitions &#39;&#39;&#39;</span>
        <span class="n">depth</span> <span class="o">=</span> <span class="n">depth</span> <span class="o">-</span> <span class="mi">1</span>
        <span class="k">for</span> <span class="n">subcktinst</span> <span class="ow">in</span> <span class="p">(</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">elements</span> <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="s1">&#39;circuit&#39;</span><span class="p">)):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_replace_subckt_with_components</span><span class="p">(</span><span class="n">subcktinst</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">any</span><span class="p">((</span><span class="nb">hasattr</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="s1">&#39;circuit&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">elements</span><span class="p">))</span> <span class="ow">and</span> <span class="n">depth</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">flatten</span><span class="p">(</span><span class="n">depth</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">element</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">elements</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">element</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">element</span><span class="o">.</span><span class="n">_prefix</span><span class="p">):</span>
                <span class="n">element</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{element._prefix}</span><span class="s1">_</span><span class="si">{element.name}</span><span class="s1">&#39;</span></div>

    <span class="k">def</span> <span class="nf">_replace_subckt_with_components</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">subcktinst</span><span class="p">):</span>
        <span class="c1"># Remove element from graph</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">remove_node</span><span class="p">(</span><span class="n">subcktinst</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
        <span class="c1"># Add new elements</span>
        <span class="k">for</span> <span class="n">element</span> <span class="ow">in</span> <span class="n">subcktinst</span><span class="o">.</span><span class="n">circuit</span><span class="o">.</span><span class="n">elements</span><span class="p">:</span>
            <span class="n">newelement</span> <span class="o">=</span> <span class="n">element</span><span class="o">.</span><span class="vm">__class__</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{subcktinst.name}</span><span class="s1">_</span><span class="si">{element.name}</span><span class="s1">&#39;</span><span class="p">,</span>
                <span class="o">*</span><span class="p">[</span><span class="n">subcktinst</span><span class="o">.</span><span class="n">pins</span><span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="k">if</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">subcktinst</span><span class="o">.</span><span class="n">pins</span> <span class="k">else</span> <span class="sa">f</span><span class="s1">&#39;{subcktinst. name}_</span><span class="si">{x}</span><span class="s1">&#39;</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">element</span><span class="o">.</span><span class="n">pins</span><span class="o">.</span><span class="n">values</span><span class="p">()],</span>
                <span class="o">**</span><span class="p">{</span><span class="n">key</span><span class="p">:</span> <span class="nb">eval</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="p">{},</span> <span class="n">subcktinst</span><span class="o">.</span><span class="n">parameters</span><span class="p">)</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="k">else</span> <span class="n">val</span> <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">element</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">items</span><span class="p">()})</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">add_element</span><span class="p">(</span><span class="n">newelement</span><span class="p">)</span></div>

<span class="c1"># WARNING: Do not add attributes/methods which may exist</span>
<span class="c1">#          in Circuit to _SubCircuitMetaClass/_SubCircuit</span>

<span class="k">class</span> <span class="nc">_SubCircuitMetaClass</span><span class="p">(</span><span class="nb">type</span><span class="p">):</span>

    <span class="k">def</span> <span class="fm">__new__</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">clsname</span><span class="p">,</span> <span class="n">bases</span><span class="p">,</span> <span class="n">attributedict</span><span class="p">):</span>
        <span class="k">if</span> <span class="s1">&#39;circuit&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">attributedict</span><span class="p">:</span> <span class="n">attributedict</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;circuit&#39;</span><span class="p">:</span> <span class="n">Circuit</span><span class="p">()})</span>
        <span class="k">if</span> <span class="s1">&#39;_parameters&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">attributedict</span><span class="p">:</span> <span class="n">attributedict</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;_parameters&#39;</span><span class="p">:</span> <span class="p">{}})</span>
        <span class="k">return</span> <span class="nb">super</span><span class="p">(</span><span class="n">_SubCircuitMetaClass</span><span class="p">,</span> <span class="bp">cls</span><span class="p">)</span><span class="o">.</span><span class="fm">__new__</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">clsname</span><span class="p">,</span> <span class="n">bases</span><span class="p">,</span> <span class="n">attributedict</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__getattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">circuit</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">ret</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">ret</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;.SUBCKT </span><span class="si">{self.__name__}</span><span class="s1"> &#39;</span> <span class="o">+</span> <span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{x}</span><span class="s1">&#39;</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pins</span><span class="p">))</span>
        <span class="n">ret</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="sa">f</span><span class="s1">&#39;.PARAM </span><span class="si">{x}</span><span class="s1">=&#39;</span> <span class="o">+</span> <span class="p">(</span><span class="sa">f</span><span class="s1">&#39;{{</span><span class="si">{y}</span><span class="s1">}}&#39;</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="k">else</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{y}</span><span class="s1">&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parameters</span><span class="o">.</span><span class="n">items</span><span class="p">()])</span>
        <span class="n">ret</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">circuit</span><span class="p">))</span>
        <span class="n">ret</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;.ENDS </span><span class="si">{self.__name__}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">ret</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">_SubCircuit</span><span class="p">(</span><span class="n">NTerminalDevice</span><span class="p">,</span> <span class="n">metaclass</span><span class="o">=</span><span class="n">_SubCircuitMetaClass</span><span class="p">):</span>
    <span class="n">_prefix</span> <span class="o">=</span> <span class="s1">&#39;X&#39;</span>

    <span class="k">def</span> <span class="fm">__getattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">name</span> <span class="o">==</span> <span class="s1">&#39;add_element&#39;</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">AssertionError</span><span class="p">(</span><span class="s2">&quot;Add elements directly to subcircuit definition (not to instance)&quot;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">name</span> <span class="o">==</span> <span class="s1">&#39;__str__&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">NTerminalDevice</span><span class="o">.</span><span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">circuit</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>

<div class="viewcode-block" id="SubCircuit"><a class="viewcode-back" href="../../../align.circuit.html#align.circuit.core.SubCircuit">[docs]</a><span class="k">def</span> <span class="nf">SubCircuit</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="o">*</span><span class="n">pins</span><span class="p">,</span> <span class="n">library</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">parameters</span><span class="p">):</span>
    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">pins</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;Subcircuit must have at least 1 pin&quot;</span>
    <span class="n">subckt</span> <span class="o">=</span> <span class="nb">type</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="p">(</span><span class="n">_SubCircuit</span><span class="p">,),</span> <span class="p">{</span><span class="s1">&#39;_pins&#39;</span><span class="p">:</span> <span class="n">pins</span><span class="p">})</span>
    <span class="n">subckt</span><span class="o">.</span><span class="n">add_parameters</span><span class="p">(</span><span class="n">parameters</span><span class="p">)</span>
    <span class="c1"># Automatically register subcircuit into library for later reuse</span>
    <span class="k">if</span> <span class="n">library</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">library</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">subckt</span>
    <span class="c1"># return new class containing subcircuit</span>
    <span class="k">return</span> <span class="n">subckt</span></div>

<div class="viewcode-block" id="Model"><a class="viewcode-back" href="../../../align.circuit.html#align.circuit.core.Model">[docs]</a><span class="k">def</span> <span class="nf">Model</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">base</span><span class="p">,</span> <span class="n">library</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">parameters</span><span class="p">):</span>
    <span class="k">assert</span> <span class="nb">issubclass</span><span class="p">(</span><span class="n">base</span><span class="p">,</span> <span class="n">NTerminalDevice</span><span class="p">),</span> <span class="n">base</span>
    <span class="n">model</span> <span class="o">=</span> <span class="nb">type</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="p">(</span><span class="n">base</span><span class="p">,</span> <span class="p">),</span> <span class="p">{</span><span class="s1">&#39;_parameters&#39;</span><span class="p">:</span> <span class="n">base</span><span class="o">.</span><span class="n">_parameters</span><span class="o">.</span><span class="n">copy</span><span class="p">()})</span>
    <span class="n">model</span><span class="o">.</span><span class="n">add_parameters</span><span class="p">(</span><span class="n">parameters</span><span class="p">)</span>
    <span class="c1"># Automatically register model into library for later reuse</span>
    <span class="k">if</span> <span class="n">library</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">library</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">model</span>
    <span class="c1"># return new class containing model</span>
    <span class="k">return</span> <span class="n">model</span></div>
</pre></div>

          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" />
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../../index.html">ALIGN 0.9 documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../../index.html" >Module code</a> &#187;</li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &#169; Copyright 2020, Kunal and ALIGN team.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 2.3.1.
    </div>
  </body>
</html>